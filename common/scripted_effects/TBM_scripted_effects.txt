# ### THe Blocker Mod - Scripted Effects

# Removes all deposits on a world, then removes any custom modifiers or effects that TBM triggers via on_cleared (e.g. Cleared Hot Springs). As a result, this should only be called at or near galaxy-generation to avoid interfering with dynamic gameplay.
clear_deposits_without_effects = {
	this = {
		every_deposit = {
			remove_deposit = yes
		}

		if = {
			limit = {
				OR = {
					has_modifier = cleared_hot_springs
					has_modifier = privatizations
				}
			}
			remove_modifier = cleared_hot_springs
			remove_modifier = privatizations
		}
	}
}

# Used to avoid removing the deposits that tend to make players happy
clear_deposits_except_special = {
	while = {
		count = trigger:num_deposits
		random_deposit = {
			limit = {
				NOR = {
					has_deposit_category = deposit_cat_rare
					has_deposit_category = deposit_cat_rare_blocker
					has_deposit_category = deposit_cat_tbm_legendary
					has_deposit_category = deposit_cat_advanced
				}
			}
			remove_deposit = yes
		}
	}
}

# Should usually be hidden.
add_from_barren = {
	random_list = {
		20 = {
			add_deposit = d_fertile_lands
		}
		20 = {
			add_deposit = d_mineral_fields		
		}
		210 = {
			add_deposit = d_floodplains
		}
		210 = {
			add_deposit = d_boggy_fens
		}
		10 = {
			add_deposit = d_mire
		}
		10 = {
			add_deposit = d_scrubland
		}
		20 = {
			add_deposit = d_rough_plains
		}
		20 = {
			add_deposit = d_misty_plains
		}
		20 = {
			add_deposit = d_drylands
		}
		5 = {
			add_deposit = d_salt_flats
		}
	}	
}

# Solution to clear a city district that takes into account alternative city types
remove_city_if_poss_and_other_if_not_regular = {
	if = {
		limit = {
			num_districts = {
				type = district_city
				value > 0
			}
		}
		remove_district = district_city
	}
	else_if = {
		limit = {
			num_districts = {
				type = district_nexus
				value > 0
			}
		}
		remove_district = district_nexus
	}
	else_if = {
		limit = {
			num_districts = {
				type = district_hive
				value > 0
			}
		}
		remove_district = district_hive
	}
	else_if = {
		limit = {
			num_districts = {
				type = district_crashed_slaver_ship
				value > 0
			}
		}
		remove_district = district_crashed_slaver_ship
	}
	else_if = {
		limit = {
			num_districts = {
				type = district_resort
				value > 0
			}
		}
		remove_district = district_resort
	}
	else_if = {
		limit = {
			num_districts = {
				type = district_prison
				value > 0
			}
		}
		remove_district = district_prison
	}
	else_if = {
		limit = {
			num_districts = {
				type = district_slave
				value > 0
			}
		}
		remove_district = district_slave
	}

	else_if = {
		limit = {
			is_artificial = yes
		}
		if = {
			limit = {
				num_districts = {
					type = any
					value > 0
				}
			}
			remove_random_district = yes
		}
		else = {
			add_planet_devastation = 25
		}
	}
	else_if = {
		limit = {
			num_districts = {
				type = any
				value > 0
			}
		}
		remove_random_district = yes
	}
	else = {
		add_planet_devastation = 25
	}
}

climate_control_activate = {
	this = {
		save_global_event_target_as = melted_deposit
	}
	random_list = {
		50 = {
			modifier = {
				factor = 0.5
				owner = { has_technology = tech_terrestrial_sculpting }
			}
			modifier = {
				factor = 0.5
				owner = { has_technology = tech_ecological_adaptation }
			}
			modifier = {
				factor = 0
				owner = { has_ascension_perk = ap_mastery_of_nature }
			}
			planet_event = {
				id = tbm.30
				days = 1
			}
		}
		50 = {}
	}
}

melt_something = {
	if = {
		limit = {
			event_target:melted_deposit = {
				is_deposit_type = d_massive_glacier
			}
		}
		add_deposit = d_glacier_lake
	}

	else_if = {
		limit = {
			event_target:melted_deposit = {
				is_deposit_type = d_frozen_wasteland
			}
		}
		add_deposit = d_lakelands
	}

	else = {
		add_deposit = d_rough_plains
	}



	clear_global_event_target = melted_deposit
}

kill_random_pop_percentage = {
	random_owned_pop_group = {	
		kill_pop_group = {
			pop_group = this
			percentage = $PERCENT$
		}
	}
}

kill_random_pop_amount = {
	random_owned_pop_group = {	
		kill_pop_group = {
			pop_group = this
			amount = $AMOUNT$
		}
	}
}

kill_2_random_pop__percentage = {
	random_owned_pop_group = {	
		kill_pop_group = {
			pop_group = this
			percentage = $PERCENT1$
		}
	}
	random_owned_pop_group = {	
		kill_pop_group = {
			pop_group = this
			percentage = $PERCENT2$
		}
	}
}

kill_3_random_pop__percentage = {
	random_owned_pop_group = {	
		kill_pop_group = {
			pop_group = this
			percentage = $PERCENT1$
		}
	}
	random_owned_pop_group = {	
		kill_pop_group = {
			pop_group = this
			percentage = $PERCENT2$
		}
	}
	random_owned_pop_group = {	
		kill_pop_group = {
			pop_group = this
			percentage = $PERCENT3$
		}
	}
}

kill_2_random_pop_amount = {
	random_owned_pop_group = {	
		kill_pop_group = {
			pop_group = this
			amount = $AMOUNT1$
		}
	}
	random_owned_pop_group = {	
		kill_pop_group = {
			pop_group = this
			amount = $AMOUNT2$
		}
	}
}

kill_3_random_pop_amount = {
	random_owned_pop_group = {	
		kill_pop_group = {
			pop_group = this
			amount = $AMOUNT1$
		}
	}
	random_owned_pop_group = {	
		kill_pop_group = {
			pop_group = this
			amount = $AMOUNT2$
		}
	}
	random_owned_pop_group = {	
		kill_pop_group = {
			pop_group = this
			amount = $AMOUNT3$
		}
	}
}

# Necessary for on_cleared blocks because they no longer include an implied exists check for some reason.
add_resource_on_clear = {
	if = {
		limit = {
			exists = owner
		}
		
		owner = {
			add_resource = {
				$resource$ = $amount$
			}
			
		}
	}
}